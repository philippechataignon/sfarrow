<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Getting started examples • sfarrow</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Getting started examples">
<meta property="og:description" content="Reading/writing with sfarrow and how it works.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">sfarrow</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/example_sfarrow.html">Getting started examples</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/wcjochem/sfarrow/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="example_sfarrow_files/header-attrs-2.10/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Getting started examples</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/wcjochem/sfarrow/blob/master/vignettes/example_sfarrow.Rmd"><code>vignettes/example_sfarrow.Rmd</code></a></small>
      <div class="hidden name"><code>example_sfarrow.Rmd</code></div>

    </div>

    
    
<p><code>sfarrow</code> is designed to help read/write spatial vector data in “simple feature” format from/to Parquet files while maintaining coordinate reference system information. Essentially, this tool is attempting to connect <code>R</code> objects in <a href="https://r-spatial.github.io/sf/"><code>sf</code></a> and in <a href="https://arrow.apache.org/docs/r/"><code>arrow</code></a> and it relies on these packages for its internal work.</p>
<p>A key goal is to support interoperability of spatial data in Parquet files. R objects (including <code>sf</code>) can be written to files with <code>arrow</code>; however, these do not necessarily maintain the spatial information or can be read in by Python. <code>sfarrow</code> implements a metadata format also used by Python <code>GeoPandas</code>, described here: <a href="https://github.com/geopandas/geo-arrow-spec">https://github.com/geopandas/geo-arrow-spec</a>. Note that these metadata are not stable yet, and <code>sfarrow</code> will warn you that it may change.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install from CRAN with install.packages('sfarrow')</span>
<span class="co"># or install from devtools::install_github("wcjochem/sfarrow@main)</span>
<span class="co"># load the library</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/wcjochem/sfarrow">sfarrow</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div id="reading-and-writing-single-files" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-and-writing-single-files" class="anchor"></a>Reading and writing single files</h2>
<p>A Parquet file (with <code>.parquet</code> extension) can be read using <code><a href="../reference/st_read_parquet.html">st_read_parquet()</a></code> and pointing to the file system. This will create an <code>sf</code> spatial data object in memory which can then be used as normal using functions from <code>sf</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># read an example dataset created from Python using geopandas</span>
<span class="va">world</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/st_read_parquet.html">st_read_parquet</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"world.parquet"</span>, package <span class="op">=</span> <span class="st">"sfarrow"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">world</span><span class="op">)</span>
<span class="co">#&gt; [1] "sf"         "data.frame"</span>
<span class="va">world</span>
<span class="co">#&gt; Simple feature collection with 177 features and 5 fields</span>
<span class="co">#&gt; Geometry type: GEOMETRY</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: -180 ymin: -90 xmax: 180 ymax: 83.64513</span>
<span class="co">#&gt; Geodetic CRS:  WGS 84</span>
<span class="co">#&gt; First 10 features:</span>
<span class="co">#&gt;      pop_est     continent                     name iso_a3 gdp_md_est</span>
<span class="co">#&gt; 1     920938       Oceania                     Fiji    FJI  8.374e+03</span>
<span class="co">#&gt; 2   53950935        Africa                 Tanzania    TZA  1.506e+05</span>
<span class="co">#&gt; 3     603253        Africa                W. Sahara    ESH  9.065e+02</span>
<span class="co">#&gt; 4   35623680 North America                   Canada    CAN  1.674e+06</span>
<span class="co">#&gt; 5  326625791 North America United States of America    USA  1.856e+07</span>
<span class="co">#&gt; 6   18556698          Asia               Kazakhstan    KAZ  4.607e+05</span>
<span class="co">#&gt; 7   29748859          Asia               Uzbekistan    UZB  2.023e+05</span>
<span class="co">#&gt; 8    6909701       Oceania         Papua New Guinea    PNG  2.802e+04</span>
<span class="co">#&gt; 9  260580739          Asia                Indonesia    IDN  3.028e+06</span>
<span class="co">#&gt; 10  44293293 South America                Argentina    ARG  8.794e+05</span>
<span class="co">#&gt;                          geometry</span>
<span class="co">#&gt; 1  MULTIPOLYGON (((180 -16.067...</span>
<span class="co">#&gt; 2  POLYGON ((33.90371 -0.95, 3...</span>
<span class="co">#&gt; 3  POLYGON ((-8.66559 27.65643...</span>
<span class="co">#&gt; 4  MULTIPOLYGON (((-122.84 49,...</span>
<span class="co">#&gt; 5  MULTIPOLYGON (((-122.84 49,...</span>
<span class="co">#&gt; 6  POLYGON ((87.35997 49.21498...</span>
<span class="co">#&gt; 7  POLYGON ((55.96819 41.30864...</span>
<span class="co">#&gt; 8  MULTIPOLYGON (((141.0002 -2...</span>
<span class="co">#&gt; 9  MULTIPOLYGON (((141.0002 -2...</span>
<span class="co">#&gt; 10 MULTIPOLYGON (((-68.63401 -...</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">world</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="example_sfarrow_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>Similarly, a Parquet file can be written from an <code>sf</code> object using <code><a href="../reference/st_write_parquet.html">st_write_parquet()</a></code> and specifying a path to the new file. Non-spatial objects cannot be written with <code>sfarrow</code>, and users should instead use <code>arrow</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># output the file to a new location</span>
<span class="co"># note the warning about possible future changes in metadata.</span>
<span class="fu"><a href="../reference/st_write_parquet.html">st_write_parquet</a></span><span class="op">(</span><span class="va">world</span>, dsn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"new_world.parquet"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Warning: This is an initial implementation of Parquet/Feather file support and</span>
<span class="co">#&gt; geo metadata. This is tracking version 0.1.0 of the metadata</span>
<span class="co">#&gt; (https://github.com/geopandas/geo-arrow-spec). This metadata</span>
<span class="co">#&gt; specification may change and does not yet make stability promises.  We</span>
<span class="co">#&gt; do not yet recommend using this in a production setting unless you are</span>
<span class="co">#&gt; able to rewrite your Parquet/Feather files.</span></code></pre></div>
</div>
<div id="partitioned-datasets" class="section level2">
<h2 class="hasAnchor">
<a href="#partitioned-datasets" class="anchor"></a>Partitioned datasets</h2>
<p>While reading/writing a Parquet file is nice, the real power of <code>arrow</code> comes from splitting big datasets into multiple files, or partitions, based on criteria that make it faster to query. There is currently basic support in <code>sfarrow</code> for multi-file spatial datasets. For additional dataset querying options, see the <code>arrow</code> <a href="https://arrow.apache.org/docs/r/articles/dataset.html">documentation</a>.</p>
<div id="querying-and-reading-datasets" class="section level3">
<h3 class="hasAnchor">
<a href="#querying-and-reading-datasets" class="anchor"></a>Querying and reading Datasets</h3>
<p><code>sfarrow</code> accesses <code>arrows</code>’s <code>dplyr</code> interface to explore partitioned, Arrow datasets.</p>
<p>For this example we will use a dataset which was created by randomly splitting the nc.shp file first into three groups and then further partitioning into two more random groups. This creates a nested set of files.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"ds"</span>, package <span class="op">=</span> <span class="st">"sfarrow"</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; [1] "split1=1/split2=1/part-3.parquet" "split1=1/split2=2/part-0.parquet"</span>
<span class="co">#&gt; [3] "split1=2/split2=1/part-1.parquet" "split1=2/split2=2/part-5.parquet"</span>
<span class="co">#&gt; [5] "split1=3/split2=1/part-2.parquet" "split1=3/split2=2/part-4.parquet"</span></code></pre></div>
<p>The file tree is showing that the data were partitioned by the variables “split1” and “split2”. Those are the column names that were used for the random splits. This partitioning is in <a href="https://hive.apache.org/">“Hive style”</a> where the partitioning variables are in the paths.</p>
<p>The first step is to open the Dataset using <code>arrow</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r//reference/open_dataset.html">open_dataset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"ds"</span>, package<span class="op">=</span><span class="st">"sfarrow"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>For small datasets (as in the example) we can read the entire set of files into an <code>sf</code> object.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nc_ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_sf_dataset.html">read_sf_dataset</a></span><span class="op">(</span><span class="va">ds</span><span class="op">)</span>

<span class="va">nc_ds</span>
<span class="co">#&gt; Simple feature collection with 100 features and 16 fields</span>
<span class="co">#&gt; Geometry type: MULTIPOLYGON</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span>
<span class="co">#&gt; Geodetic CRS:  NAD27</span>
<span class="co">#&gt; First 10 features:</span>
<span class="co">#&gt;     AREA PERIMETER CNTY_ CNTY_ID     NAME  FIPS FIPSNO CRESS_ID BIR74 SID74</span>
<span class="co">#&gt; 1  0.097     1.670  1833    1833 Hertford 37091  37091       46  1452     7</span>
<span class="co">#&gt; 2  0.062     1.547  1834    1834   Camden 37029  37029       15   286     0</span>
<span class="co">#&gt; 3  0.109     1.325  1841    1841   Person 37145  37145       73  1556     4</span>
<span class="co">#&gt; 4  0.081     1.288  1880    1880  Watauga 37189  37189       95  1323     1</span>
<span class="co">#&gt; 5  0.044     1.158  1887    1887   Chowan 37041  37041       21   751     1</span>
<span class="co">#&gt; 6  0.086     1.267  1893    1893   Yadkin 37197  37197       99  1269     1</span>
<span class="co">#&gt; 7  0.170     1.680  1903    1903 Guilford 37081  37081       41 16184    23</span>
<span class="co">#&gt; 8  0.118     1.601  1946    1946  Madison 37115  37115       58   765     2</span>
<span class="co">#&gt; 9  0.134     1.755  1958    1958    Burke 37023  37023       12  3573     5</span>
<span class="co">#&gt; 10 0.116     1.664  1964    1964 McDowell 37111  37111       56  1946     5</span>
<span class="co">#&gt;    NWBIR74 BIR79 SID79 NWBIR79 split1 split2                       geometry</span>
<span class="co">#&gt; 1      954  1838     5    1237      1      1 MULTIPOLYGON (((-76.74506 3...</span>
<span class="co">#&gt; 2      115   350     2     139      1      1 MULTIPOLYGON (((-76.00897 3...</span>
<span class="co">#&gt; 3      613  1790     4     650      1      1 MULTIPOLYGON (((-78.8068 36...</span>
<span class="co">#&gt; 4       17  1775     1      33      1      1 MULTIPOLYGON (((-81.80622 3...</span>
<span class="co">#&gt; 5      368   899     1     491      1      1 MULTIPOLYGON (((-76.68874 3...</span>
<span class="co">#&gt; 6       65  1568     1      76      1      1 MULTIPOLYGON (((-80.49554 3...</span>
<span class="co">#&gt; 7     5483 20543    38    7089      1      1 MULTIPOLYGON (((-79.53782 3...</span>
<span class="co">#&gt; 8        5   926     2       3      1      1 MULTIPOLYGON (((-82.89597 3...</span>
<span class="co">#&gt; 9      326  4314    15     407      1      1 MULTIPOLYGON (((-81.81628 3...</span>
<span class="co">#&gt; 10     134  2215     5     128      1      1 MULTIPOLYGON (((-81.81628 3...</span></code></pre></div>
<p>With large datasets, more often we will want query them and return a reduced set of the partitioned records. To create a query, the easiest way is to use <code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter()</a></code> on the partitioning (and/or other) variables to subset the rows and <code><a href="https://dplyr.tidyverse.org/reference/select.html">dplyr::select()</a></code> to subset the columns. <code><a href="../reference/read_sf_dataset.html">read_sf_dataset()</a></code> will then use the <code>arrow_dplyr_query</code> and call <code><a href="https://dplyr.tidyverse.org/reference/compute.html">dplyr::collect()</a></code> to extract and then process the Arrow Table into <code>sf</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nc_d12</span> <span class="op">&lt;-</span> <span class="va">ds</span> <span class="op">%&gt;%</span> 
            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">split1</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">split2</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span>
            <span class="fu"><a href="../reference/read_sf_dataset.html">read_sf_dataset</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">nc_d12</span>
<span class="co">#&gt; Simple feature collection with 20 features and 16 fields</span>
<span class="co">#&gt; Geometry type: MULTIPOLYGON</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: -83.36472 ymin: 34.71101 xmax: -75.45698 ymax: 36.58965</span>
<span class="co">#&gt; Geodetic CRS:  NAD27</span>
<span class="co">#&gt; First 10 features:</span>
<span class="co">#&gt;     AREA PERIMETER CNTY_ CNTY_ID        NAME  FIPS FIPSNO CRESS_ID BIR74 SID74</span>
<span class="co">#&gt; 1  0.114     1.442  1825    1825        Ashe 37009  37009        5  1091     1</span>
<span class="co">#&gt; 2  0.143     1.630  1828    1828       Surry 37171  37171       86  3188     5</span>
<span class="co">#&gt; 3  0.153     2.206  1832    1832 Northampton 37131  37131       66  1421     9</span>
<span class="co">#&gt; 4  0.118     1.421  1836    1836      Warren 37185  37185       93   968     4</span>
<span class="co">#&gt; 5  0.114     1.352  1838    1838     Caswell 37033  37033       17  1035     2</span>
<span class="co">#&gt; 6  0.143     1.663  1840    1840   Granville 37077  37077       39  1671     4</span>
<span class="co">#&gt; 7  0.108     1.483  1900    1900     Forsyth 37067  37067       34 11858    10</span>
<span class="co">#&gt; 8  0.111     1.392  1904    1904    Alamance 37001  37001        1  4672    13</span>
<span class="co">#&gt; 9  0.104     1.294  1907    1907      Orange 37135  37135       68  3164     4</span>
<span class="co">#&gt; 10 0.122     1.516  1932    1932    Caldwell 37027  37027       14  3609     6</span>
<span class="co">#&gt;    NWBIR74 BIR79 SID79 NWBIR79 split1 split2                       geometry</span>
<span class="co">#&gt; 1       10  1364     0      19      1      2 MULTIPOLYGON (((-81.47276 3...</span>
<span class="co">#&gt; 2      208  3616     6     260      1      2 MULTIPOLYGON (((-80.45634 3...</span>
<span class="co">#&gt; 3     1066  1606     3    1197      1      2 MULTIPOLYGON (((-77.21767 3...</span>
<span class="co">#&gt; 4      748  1190     2     844      1      2 MULTIPOLYGON (((-78.30876 3...</span>
<span class="co">#&gt; 5      550  1253     2     597      1      2 MULTIPOLYGON (((-79.53051 3...</span>
<span class="co">#&gt; 6      930  2074     4    1058      1      2 MULTIPOLYGON (((-78.74912 3...</span>
<span class="co">#&gt; 7     3919 15704    18    5031      1      2 MULTIPOLYGON (((-80.0381 36...</span>
<span class="co">#&gt; 8     1243  5767    11    1397      1      2 MULTIPOLYGON (((-79.24619 3...</span>
<span class="co">#&gt; 9      776  4478     6    1086      1      2 MULTIPOLYGON (((-79.01814 3...</span>
<span class="co">#&gt; 10     309  4249     9     360      1      2 MULTIPOLYGON (((-81.32813 3...</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">nc_d12</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"grey"</span><span class="op">)</span></code></pre></div>
<p><img src="example_sfarrow_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>When using <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> to read only a subset of columns, if the geometry column is not returned, the default behaviour of <code>sfarrow</code> is to throw an error from <code>read_sf_dataset</code>. If you do not need the geometry column for your analyses, then using <code>arrow</code> and not <code>sfarrow</code> should be sufficient. However, setting <code>find_geom = TRUE</code> in <code>read_sf_dataset</code> will read in any geometry columns in the metadata, in addition to the selected columns.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># this command will throw an error</span>
<span class="co"># no geometry column selected for read_sf_dataset</span>
<span class="co"># nc_sub &lt;- ds %&gt;% </span>
<span class="co">#             select('FIPS') %&gt;% # subset of columns</span>
<span class="co">#             read_sf_dataset()</span>

<span class="co"># set find_geom</span>
<span class="va">nc_sub</span> <span class="op">&lt;-</span> <span class="va">ds</span> <span class="op">%&gt;%</span>
            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">'FIPS'</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># subset of columns</span>
            <span class="fu"><a href="../reference/read_sf_dataset.html">read_sf_dataset</a></span><span class="op">(</span>find_geom <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">nc_sub</span>
<span class="co">#&gt; Simple feature collection with 100 features and 1 field</span>
<span class="co">#&gt; Geometry type: MULTIPOLYGON</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span>
<span class="co">#&gt; Geodetic CRS:  NAD27</span>
<span class="co">#&gt; First 10 features:</span>
<span class="co">#&gt;     FIPS                       geometry</span>
<span class="co">#&gt; 1  37091 MULTIPOLYGON (((-76.74506 3...</span>
<span class="co">#&gt; 2  37029 MULTIPOLYGON (((-76.00897 3...</span>
<span class="co">#&gt; 3  37145 MULTIPOLYGON (((-78.8068 36...</span>
<span class="co">#&gt; 4  37189 MULTIPOLYGON (((-81.80622 3...</span>
<span class="co">#&gt; 5  37041 MULTIPOLYGON (((-76.68874 3...</span>
<span class="co">#&gt; 6  37197 MULTIPOLYGON (((-80.49554 3...</span>
<span class="co">#&gt; 7  37081 MULTIPOLYGON (((-79.53782 3...</span>
<span class="co">#&gt; 8  37115 MULTIPOLYGON (((-82.89597 3...</span>
<span class="co">#&gt; 9  37023 MULTIPOLYGON (((-81.81628 3...</span>
<span class="co">#&gt; 10 37111 MULTIPOLYGON (((-81.81628 3...</span></code></pre></div>
</div>
<div id="writing-to-datasets" class="section level3">
<h3 class="hasAnchor">
<a href="#writing-to-datasets" class="anchor"></a>Writing to Datasets</h3>
<p>To write an <code>sf</code> object into multiple files, we can again construct a query using <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">dplyr::group_by()</a></code> to define the partitioning variables. The result is then passed to <code>sfarrow</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">world</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">continent</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/write_sf_dataset.html">write_sf_dataset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"world_ds"</span><span class="op">)</span>, 
                   format <span class="op">=</span> <span class="st">"parquet"</span>,
                   hive_style <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; Warning: This is an initial implementation of Parquet/Feather file support and</span>
<span class="co">#&gt; geo metadata. This is tracking version 0.1.0 of the metadata</span>
<span class="co">#&gt; (https://github.com/geopandas/geo-arrow-spec). This metadata</span>
<span class="co">#&gt; specification may change and does not yet make stability promises.  We</span>
<span class="co">#&gt; do not yet recommend using this in a production setting unless you are</span>
<span class="co">#&gt; able to rewrite your Parquet/Feather files.</span></code></pre></div>
<p>In this example we are not using Hive style. This results in the partitioning variable not being in the folder paths.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"world_ds"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] "Africa"                  "Antarctica"             </span>
<span class="co">#&gt; [3] "Asia"                    "Europe"                 </span>
<span class="co">#&gt; [5] "North America"           "Oceania"                </span>
<span class="co">#&gt; [7] "Seven seas (open ocean)" "South America"</span></code></pre></div>
<p>To read this style of Dataset, we must specify the partitioning variables when it is opened.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r//reference/open_dataset.html">open_dataset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"world_ds"</span><span class="op">)</span>, 
                    partitioning <span class="op">=</span> <span class="st">"continent"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">continent</span> <span class="op">==</span> <span class="st">"Africa"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/read_sf_dataset.html">read_sf_dataset</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Simple feature collection with 51 features and 5 fields</span>
<span class="co">#&gt; Geometry type: GEOMETRY</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: -17.62504 ymin: -34.81917 xmax: 51.13387 ymax: 37.34999</span>
<span class="co">#&gt; Geodetic CRS:  WGS 84</span>
<span class="co">#&gt; First 10 features:</span>
<span class="co">#&gt;     pop_est            name iso_a3 gdp_md_est continent</span>
<span class="co">#&gt; 1  53950935        Tanzania    TZA   150600.0    Africa</span>
<span class="co">#&gt; 2    603253       W. Sahara    ESH      906.5    Africa</span>
<span class="co">#&gt; 3  83301151 Dem. Rep. Congo    COD    66010.0    Africa</span>
<span class="co">#&gt; 4   7531386         Somalia    SOM     4719.0    Africa</span>
<span class="co">#&gt; 5  47615739           Kenya    KEN   152700.0    Africa</span>
<span class="co">#&gt; 6  37345935           Sudan    SDN   176300.0    Africa</span>
<span class="co">#&gt; 7  12075985            Chad    TCD    30590.0    Africa</span>
<span class="co">#&gt; 8  54841552    South Africa    ZAF   739100.0    Africa</span>
<span class="co">#&gt; 9   1958042         Lesotho    LSO     6019.0    Africa</span>
<span class="co">#&gt; 10 13805084        Zimbabwe    ZWE    28330.0    Africa</span>
<span class="co">#&gt;                          geometry</span>
<span class="co">#&gt; 1  POLYGON ((33.90371 -0.95, 3...</span>
<span class="co">#&gt; 2  POLYGON ((-8.66559 27.65643...</span>
<span class="co">#&gt; 3  POLYGON ((29.34 -4.499983, ...</span>
<span class="co">#&gt; 4  POLYGON ((41.58513 -1.68325...</span>
<span class="co">#&gt; 5  POLYGON ((39.20222 -4.67677...</span>
<span class="co">#&gt; 6  POLYGON ((24.56737 8.229188...</span>
<span class="co">#&gt; 7  POLYGON ((23.83766 19.58047...</span>
<span class="co">#&gt; 8  POLYGON ((16.34498 -28.5767...</span>
<span class="co">#&gt; 9  POLYGON ((28.97826 -28.9556...</span>
<span class="co">#&gt; 10 POLYGON ((31.19141 -22.2515...</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Chris Jochem.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
